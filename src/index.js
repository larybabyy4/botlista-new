import TelegramBot from 'node-telegram-bot-api';
import schedule from 'node-schedule';
import express from 'express';
import fs from 'fs';
import dotenv from 'dotenv';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

// Setup __dirname equivalent for ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Load environment variables
dotenv.config();

// Initialize Express
const app = express();
app.set('view engine', 'ejs');
app.set('views', join(__dirname, 'views'));
app.use(express.urlencoded({ extended: true }));

// Initialize JSON storage
const DB_FILE = './database.json';
let db = {
  channels: [],
  users: []
};

// Load database from file
try {
  if (fs.existsSync(DB_FILE)) {
    db = JSON.parse(fs.readFileSync(DB_FILE, 'utf8'));
  }
} catch (error) {
  console.error('Error loading database:', error);
}

// Save database to file
function saveDB() {
  try {
    fs.writeFileSync(DB_FILE, JSON.stringify(db, null, 2));
  } catch (error) {
    console.error('Error saving database:', error);
  }
}

// Initialize bot
const bot = new TelegramBot(process.env.BOT_TOKEN, { 
  polling: true,
  filepath: false
});

// Error handlers
bot.on('polling_error', (error) => {
  console.error('Bot polling error:', error);
});

bot.on('error', (error) => {
  console.error('Bot general error:', error);
});

// Helper functions
function findUser(userId) {
  return db.users.find(u => u.userId === userId.toString());
}

function createUser(userId) {
  const user = {
    userId: userId.toString(),
    channelCount: 0,
    isBanned: false
  };
  db.users.push(user);
  saveDB();
  return user;
}

function findChannel(channelId) {
  return db.channels.find(c => c.channelId === channelId.toString());
}

// Create chunks of array for buttons
function chunkArray(array, size) {
  const chunks = [];
  for (let i = 0; i < array.length; i += size) {
    chunks.push(array.slice(i, i + size));
  }
  return chunks;
}

// Web interface routes
app.get('/', (req, res) => {
  const stats = {
    totalChannels: db.channels.length,
    totalUsers: db.users.length,
    pendingApproval: db.channels.filter(c => !c.isApproved).length,
    categories: {
      '100-1000': db.channels.filter(c => c.category === '100-1000').length,
      '1000-5000': db.channels.filter(c => c.category === '1000-5000').length,
      '5000+': db.channels.filter(c => c.category === '5000+').length
    }
  };
  
  res.render('dashboard', { 
    channels: db.channels,
    users: db.users,
    stats
  });
});

app.post('/approve/:channelId', (req, res) => {
  const channel = findChannel(req.params.channelId);
  if (channel) {
    channel.isApproved = true;
    saveDB();
    bot.sendMessage(channel.channelId, 
      '‚úÖ Canal/grupo aprovado!\n' +
      'As divulga√ß√µes come√ßar√£o no pr√≥ximo ciclo.'
    );
  }
  res.redirect('/');
});

app.post('/disapprove/:channelId', (req, res) => {
  const channel = findChannel(req.params.channelId);
  if (channel) {
    channel.isApproved = false;
    saveDB();
    bot.sendMessage(channel.channelId, 
      '‚ùå Canal/grupo desaprovado.\n' +
      'Entre em contato com o administrador para mais informa√ß√µes.'
    );
  }
  res.redirect('/');
});

app.post('/ban/:userId', (req, res) => {
  const user = findUser(req.params.userId);
  if (user) {
    user.isBanned = true;
    saveDB();
  }
  res.redirect('/');
});

app.post('/unban/:userId', (req, res) => {
  const user = findUser(req.params.userId);
  if (user) {
    user.isBanned = false;
    saveDB();
  }
  res.redirect('/');
});

// Auto-register channel when bot is added as admin
bot.on('my_chat_member', async (chatMember) => {
  try {
    if ((chatMember.chat.type === 'channel' || chatMember.chat.type === 'supergroup') && 
        chatMember.new_chat_member.status === 'administrator') {
      
      const channelId = chatMember.chat.id;
      const chatInfo = await bot.getChat(channelId);
      const memberCount = await bot.getChatMemberCount(channelId);
      const addedBy = chatMember.from.id;
      let user = findUser(addedBy) || createUser(addedBy);
      
      if (user.isBanned) {
        await bot.sendMessage(channelId, '‚ùå Usu√°rio banido n√£o pode registrar canais/grupos.');
        return;
      }

      if (user.channelCount >= 3) {
        await bot.sendMessage(channelId, '‚ùå Limite m√°ximo de 3 canais/grupos atingido.');
        return;
      }

      if (memberCount < 100) {
        await bot.sendMessage(channelId, 
          '‚ùå Canal/grupo n√£o registrado: m√≠nimo de 100 membros necess√°rio.\n' +
          `Membros atuais: ${memberCount}`
        );
        return;
      }

      // Generate invite link
      let inviteLink;
      try {
        inviteLink = await bot.exportChatInviteLink(channelId);
      } catch (error) {
        console.error('Error generating invite link:', error);
        inviteLink = null;
      }

      let category;
      if (memberCount < 1000) category = '100-1000';
      else if (memberCount < 5000) category = '1000-5000';
      else category = '5000+';

      const channel = {
        channelId: channelId.toString(),
        title: chatInfo.title,
        memberCount,
        category,
        ownerId: addedBy.toString(),
        username: chatInfo.username,
        inviteLink,
        isApproved: false,
        type: chatMember.chat.type
      };

      const existingChannel = findChannel(channelId);
      if (existingChannel) {
        Object.assign(existingChannel, channel);
      } else {
        db.channels.push(channel);
        user.channelCount++;
      }

      saveDB();

      await bot.sendMessage(channelId, 
        '‚úÖ Canal/grupo registrado automaticamente!\n\n' +
        `üìå T√≠tulo: ${chatInfo.title}\n` +
        `üë• Membros: ${memberCount}\n` +
        `üìä Categoria: ${category}\n` +
        `üîó Link de convite: ${inviteLink || 'N√£o dispon√≠vel'}\n\n` +
        '‚ÑπÔ∏è Aguardando aprova√ß√£o para in√≠cio das divulga√ß√µes.'
      );
    }
  } catch (error) {
    console.error('Error in auto-registration:', error);
    try {
      await bot.sendMessage(chatMember.chat.id, 
        '‚ùå Erro ao registrar canal/grupo automaticamente.\n' +
        'Por favor, verifique se o bot tem todas as permiss√µes necess√°rias.'
      );
    } catch (sendError) {
      console.error('Error sending error message:', sendError);
    }
  }
});

// Bot commands
bot.onText(/\/start/, async (msg) => {
  try {
    const chatId = msg.chat.id;
    console.log('Start command received from:', chatId);
    
    await bot.sendMessage(chatId, 
      'Bem-vindo ao Bot de Divulga√ß√£o! üì¢\n\n' +
      'Comandos dispon√≠veis:\n' +
      '/registrar - Registrar um novo canal/grupo\n' +
      '/minhascanais - Ver seus canais/grupos registrados\n' +
      '/listas - Ver listas de divulga√ß√£o\n' +
      '/ajuda - Ver instru√ß√µes de uso'
    );
  } catch (error) {
    console.error('Error in /start command:', error);
  }
});

bot.onText(/\/registrar/, async (msg) => {
  try {
    const userId = msg.from.id;
    const chatId = msg.chat.id;
    console.log('Register command received from:', userId);
    
    let user = findUser(userId) || createUser(userId);

    if (user.isBanned) {
      return bot.sendMessage(chatId, '‚ùå Voc√™ est√° banido e n√£o pode registrar canais/grupos.');
    }

    if (user.channelCount >= 3) {
      return bot.sendMessage(chatId, '‚ùå Voc√™ j√° atingiu o limite m√°ximo de 3 canais/grupos.');
    }

    await bot.sendMessage(chatId, 
      'üìù Para registrar um canal ou grupo:\n\n' +
      '1. Adicione este bot como administrador\n' +
      '2. O registro ser√° feito automaticamente!\n\n' +
      'Requisitos:\n' +
      '‚Ä¢ M√≠nimo de 100 membros\n' +
      '‚Ä¢ Canal/grupo deve ser p√∫blico\n' +
      '‚Ä¢ Bot precisa ser administrador'
    );
  } catch (error) {
    console.error('Error in /registrar command:', error);
    await bot.sendMessage(msg.chat.id, '‚ùå Ocorreu um erro ao processar seu comando. Por favor, tente novamente.');
  }
});

bot.onText(/\/minhascanais/, async (msg) => {
  try {
    const userId = msg.from.id;
    const chatId = msg.chat.id;
    console.log('My channels command received from:', userId);

    const userChannels = db.channels.filter(c => c.ownerId === userId.toString());

    if (userChannels.length === 0) {
      return bot.sendMessage(chatId, 'üì¢ Voc√™ ainda n√£o tem canais/grupos registrados.');
    }

    const channelList = userChannels.map(channel => 
      `üìå ${channel.title}\n` +
      `üë• ${channel.memberCount} membros\n` +
      `üìä Categoria: ${channel.category}\n` +
      `‚úÖ Aprovado: ${channel.isApproved ? 'Sim' : 'N√£o'}\n` +
      `üì± Tipo: ${channel.type === 'channel' ? 'Canal' : 'Grupo'}\n` +
      `üîó Link: ${channel.inviteLink || 'N√£o dispon√≠vel'}\n`
    ).join('\n');

    await bot.sendMessage(chatId, 
      'üìã Seus canais/grupos registrados:\n\n' + channelList
    );
  } catch (error) {
    console.error('Error in /minhascanais command:', error);
    await bot.sendMessage(msg.chat.id, '‚ùå Ocorreu um erro ao listar seus canais/grupos. Por favor, tente novamente.');
  }
});

bot.onText(/\/listas/, async (msg) => {
  try {
    const chatId = msg.chat.id;
    console.log('Lists command received from:', chatId);

    const categories = ['100-1000', '1000-5000', '5000+'];
    let fullMessage = 'üì¢ Listas de Divulga√ß√£o\n\n';

    for (const category of categories) {
      const channels = db.channels.filter(c => c.category === category && c.isApproved);

      if (channels.length > 0) {
        fullMessage += `üìä Categoria ${category} membros:\n`;
        channels.forEach(channel => {
          fullMessage += `‚Ä¢ ${channel.title} (${channel.type === 'channel' ? 'Canal' : 'Grupo'})\n  ${channel.inviteLink || '@' + channel.username}\n`;
        });
        fullMessage += '\n';
      }
    }

    await bot.sendMessage(chatId, fullMessage);
  } catch (error) {
    console.error('Error in /listas command:', error);
    await bot.sendMessage(msg.chat.id, '‚ùå Ocorreu um erro ao listar os canais/grupos. Por favor, tente novamente.');
  }
});

bot.onText(/\/ajuda/, async (msg) => {
  try {
    const chatId = msg.chat.id;
    console.log('Help command received from:', chatId);

    await bot.sendMessage(chatId,
      'üìñ Instru√ß√µes de Uso\n\n' +
      '1Ô∏è‚É£ Para registrar um canal ou grupo:\n' +
      '‚Ä¢ Use /registrar para ver as instru√ß√µes\n' +
      '‚Ä¢ Adicione o bot como admin\n' +
      '‚Ä¢ O registro ser√° autom√°tico!\n\n' +
      '2Ô∏è‚É£ Requisitos:\n' +
      '‚Ä¢ M√≠nimo 100 membros\n' +
      '‚Ä¢ Canal/grupo deve ser p√∫blico\n' +
      '‚Ä¢ Bot precisa ser admin\n\n' +
      '3Ô∏è‚É£ Limites:\n' +
      '‚Ä¢ M√°ximo 3 canais/grupos por usu√°rio\n' +
      '‚Ä¢ Divulga√ß√£o a cada minuto\n\n' +
      '4Ô∏è‚É£ Comandos:\n' +
      '/start - Iniciar bot\n' +
      '/registrar - Novo canal/grupo\n' +
      '/minhascanais - Ver seus canais/grupos\n' +
      '/listas - Ver divulga√ß√µes\n' +
      '/ajuda - Ver este menu'
    );
  } catch (error) {
    console.error('Error in /ajuda command:', error);
    await bot.sendMessage(msg.chat.id, '‚ùå Ocorreu um erro ao mostrar a ajuda. Por favor, tente novamente.');
  }
});

// Schedule promotional posts every minute
schedule.scheduleJob('*/10 * * * *', async () => {
  try {
    const categories = ['100-1000', '1000-5000', '5000+'];
    
    for (const category of categories) {
      const channels = db.channels.filter(c => c.category === category && c.isApproved);
      if (channels.length === 0) continue;

      // Create header message
      const headerMessage = `üì¢ Lista de Canais e Grupos Parceiros\n` +
                          `üìä Categoria: ${category} membros\n` +
                          `üë• Total: ${channels.length} participantes\n\n` +
                          `Clique nos bot√µes abaixo para entrar:`;

      // Create inline keyboard with up to 20 buttons
      const inlineKeyboard = channels.slice(0, 20).map(channel => [{
        text: `${channel.title} (${channel.type === 'channel' ? 'Canal' : 'Grupo'})`,
        url: channel.inviteLink || `https://t.me/${channel.username}`
      }]);

      // Footer message
      const footerMessage = '\n\nüí° Divulga√ß√£o autom√°tica a cada minuto\n' +
                          'ü§ñ Para participar, adicione nosso bot como admin!';

      for (const channel of channels) {
        try {
          const sent = await bot.sendMessage(channel.channelId, headerMessage, {
            parse_mode: 'HTML',
            disable_web_page_preview: true,
            reply_markup: {
              inline_keyboard: inlineKeyboard
            }
          });
          
          // Pin message for 30 seconds if it's a channel
          if (channel.type === 'channel') {
            await bot.pinChatMessage(channel.channelId, sent.message_id);
            setTimeout(() => {
              bot.unpinChatMessage(channel.channelId);
            }, 30000);
          }

          // Send footer as separate message
          await bot.sendMessage(channel.channelId, footerMessage);
        } catch (error) {
          console.error(`Error posting to ${channel.type} ${channel.title}:`, error);
        }
      }
    }
  } catch (error) {
    console.error('Error in promotional post schedule:', error);
  }
});

// Start server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`üåê Interface de gerenciamento rodando em http://localhost:${PORT}`);
  console.log('ü§ñ Bot iniciado com sucesso!');
});
